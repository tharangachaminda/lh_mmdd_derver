<div class="question-generator">
  <!-- Header -->
  <div class="generator-header">
    <button class="back-btn" (click)="returnToDashboard()">‚Üê Back to Dashboard</button>
    <h1>AI Question Generator</h1>
    <p>Get personalized questions designed just for you!</p>
  </div>

  <!-- Error Message -->
  @if (error) {
  <div class="error-message">
    <span>‚ö†Ô∏è {{ error }}</span>
    <button (click)="error = null">√ó</button>
  </div>
  }

  <!-- Step 4: Question Interface -->
  @if (currentQuestion) {
  <div class="questions-step">
    <!-- AI Quality Metrics Panel -->
    @if (qualityMetrics) {
    <div class="ai-metrics-panel">
      <button
        class="ai-metrics-toggle"
        (click)="toggleAIMetrics()"
        [class.expanded]="showAIMetrics"
      >
        <span class="ai-icon">‚ú®</span>
        <span>Question Quality</span>
        <span class="toggle-icon" [class.rotated]="showAIMetrics">‚ñº</span>
      </button>

      @if (showAIMetrics) {
      <div class="ai-metrics-content">
        <!-- Overall Quality Score (Prominent Display) -->
        <div class="overall-quality-card">
          <div class="overall-score-badge" [class]="getQualityColorClass(getOverallQualityScore())">
            <div class="score-value">{{ (getOverallQualityScore() * 100).toFixed(0) }}%</div>
            <div class="score-label">Overall Quality</div>
          </div>
          <div class="overall-quality-progress">
            <div
              class="overall-progress-fill"
              [style.width.%]="getOverallQualityScore() * 100"
              [class]="getQualityColorClass(getOverallQualityScore())"
            ></div>
          </div>
          <p class="overall-quality-message">{{ getOverallQualityDescription() }}</p>
        </div>

        <!-- Technical Details (Collapsed by default) -->
        <details class="technical-details">
          <summary class="details-toggle">
            <span>View detailed scores</span>
          </summary>

          <div class="details-content">
            <h4 class="details-title">How we calculated this:</h4>
            <div class="metrics-grid">
              <div class="metric-item-simple">
                <span class="metric-simple-label">üìö Content Match:</span>
                <span class="metric-simple-value"
                  >{{ (qualityMetrics.vectorRelevanceScore * 100).toFixed(0) }}%</span
                >
              </div>
              <div class="metric-item-simple">
                <span class="metric-simple-label">‚úÖ Accuracy:</span>
                <span class="metric-simple-value"
                  >{{ (qualityMetrics.agenticValidationScore * 100).toFixed(0) }}%</span
                >
              </div>
              <div class="metric-item-simple">
                <span class="metric-simple-label">üéØ Personalization:</span>
                <span class="metric-simple-value"
                  >{{ (qualityMetrics.personalizationScore * 100).toFixed(0) }}%</span
                >
              </div>
            </div>

            <p class="details-explanation">
              <small>
                <strong>Content Match:</strong> How well the questions align with your learning
                level.<br />
                <strong>Accuracy:</strong> Questions are mathematically correct and
                age-appropriate.<br />
                <strong>Personalization:</strong> Questions are tailored to your interests and
                learning style.
              </small>
            </p>
          </div>
        </details>
      </div>
      }
    </div>
    }

    <div class="question-progress">
      <div class="progress-bar">
        <div
          class="progress-fill"
          [style.width.%]="
            ((currentQuestionIndex + 1) /
              (currentSession?.questions?.length || totalExpectedQuestions || 1)) *
            100
          "
        ></div>
      </div>
      <span class="progress-text">
        Question {{ currentQuestionIndex + 1 }} of
        {{ currentSession?.questions?.length || totalExpectedQuestions || 0 }}
        @if (isStreaming) {
        <span class="streaming-indicator"> (Loading...)</span>
        }
      </span>
    </div>

    <!-- STREAMING: Pagination buttons for all questions -->
    @if (totalExpectedQuestions > 1) {
    <div class="question-pagination">
      @for (questionNum of [].constructor(totalExpectedQuestions); track $index) {
      <button
        class="pagination-btn"
        [class.active]="currentQuestionIndex === $index"
        [class.loading]="!isQuestionLoaded($index)"
        [disabled]="!isQuestionLoaded($index)"
        (click)="currentQuestionIndex = $index; currentQuestion = streamingQuestions[$index] || currentSession?.questions?.[$index]"
        [attr.aria-label]="'Go to question ' + ($index + 1)"
      >
        @if (isQuestionLoaded($index)) {
        {{ $index + 1 }}
        } @else {
        <span class="loading-dot"></span>
        }
      </button>
      }
    </div>
    }

    <!-- STREAMING: Show skeleton if question is loading -->
    @if (!isQuestionLoaded(currentQuestionIndex)) {
    <app-question-skeleton />
    }

    <!-- Show real question if loaded -->
    @if (isQuestionLoaded(currentQuestionIndex) && currentQuestion) {
    <div class="question-card">
      <div class="question-header">
        <span class="question-topic">{{ selectedSubject | titlecase }} - {{ selectedTopic }}</span>
        <span class="question-difficulty">{{ selectedDifficulty | titlecase }}</span>
      </div>

      <div class="question-content">
        <h3>{{ currentQuestion.question }}</h3>

        <!-- Text Answer Input -->
        @if (currentQuestion.questionType !== 'multiple_choice' || isShortAnswerMode) {
        <div class="answer-input">
          <textarea
            [(ngModel)]="userAnswer"
            (ngModelChange)="onAnswerChange()"
            placeholder="Type your answer here..."
            class="answer-textarea"
          >
          </textarea>
          @if (isShortAnswerMode) {
          <p class="answer-hint">
            <small>‚úèÔ∏è Your answer is saved automatically. You can review it later.</small>
          </p>
          }
        </div>
        }

        <!-- Navigation Controls (moved here) -->
        <div
          class="question-navigation"
          style="display: flex; gap: 1rem; margin: 1rem 0; justify-content: center"
        >
          <button
            mat-stroked-button
            color="primary"
            class="previous-question"
            (click)="goToPreviousQuestion()"
            [disabled]="currentQuestionIndex === 0"
            aria-label="Go to previous question"
          >
            <mat-icon>arrow_back</mat-icon>
            Previous
          </button>
          <button mat-stroked-button color="primary" class="reset-questions">
            {{ questionCount }}
          </button>
          <button
            mat-raised-button
            color="accent"
            class="next-question"
            (click)="goToNextQuestion()"
            [disabled]="currentQuestionIndex === (currentSession?.questions?.length || 1) - 1"
            aria-label="Go to next question"
          >
            Next
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>

      <!-- PHASE A6.2: Submit All Answers (Short-Answer Mode) -->
      @if (isShortAnswerMode) {
      <div
        class="submit-all-section"
        style="
          margin: 2rem 0;
          padding: 1.5rem;
          border: 2px solid #4caf50;
          border-radius: 8px;
          background: #f1f8e9;
        "
      >
        <div class="submission-progress" style="margin-bottom: 1rem">
          <p class="progress-label" style="font-size: 1.1rem; margin-bottom: 0.5rem">
            <strong>Progress:</strong> {{ getAnsweredCount() }} /
            {{ currentSession?.questions?.length || 0 }} questions answered
          </p>
          <div
            class="progress-bar"
            style="height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden"
          >
            <div
              class="progress-fill"
              style="
                height: 100%;
                background: linear-gradient(90deg, #4caf50, #66bb6a);
                transition: width 0.3s ease;
              "
              [style.width.%]="
                (getAnsweredCount() / (currentSession?.questions?.length || 1)) * 100
              "
            ></div>
          </div>
        </div>

        <button
          mat-raised-button
          color="primary"
          class="submit-all-btn"
          style="width: 100%; padding: 1rem; font-size: 1.1rem"
          (click)="submitAllAnswers()"
          [disabled]="!allQuestionsAnswered() || isSubmittingAnswers"
        >
          @if (isSubmittingAnswers) { ‚è≥ Validating Answers... } @else if (allQuestionsAnswered()) {
          ‚úÖ Submit All Answers for Review } @else { ‚úèÔ∏è Answer All Questions First ({{
            getAnsweredCount()
          }}/{{ currentSession?.questions?.length || 0 }}) }
        </button>

        @if (!allQuestionsAnswered()) {
        <p class="validation-hint" style="margin-top: 1rem; color: #f57c00; text-align: center">
          <small>‚ö†Ô∏è Please answer all questions before submitting for AI validation.</small>
        </p>
        }
      </div>
      }

      <!-- Original Question Actions (Legacy Mode or Individual Submit) -->
      @if (!isShortAnswerMode) {
      <div class="question-actions">
        @if (currentQuestion.hints.length > 0) {
        <button
          class="hint-btn"
          (click)="showQuestionHint()"
          [disabled]="showHint || currentQuestion.hints.length === 0"
        >
          üí° Get Hint ({{ hintsUsed }}/{{ currentQuestion.hints.length }})
        </button>
        }

        <button
          class="submit-btn"
          (click)="submitAnswer()"
          [disabled]="!userAnswer.trim() || loading"
        >
          {{ loading ? 'Submitting...' : 'Submit Answer' }}
        </button>
      </div>
      }

      <!-- Hint Display -->
      @if (showHint && currentQuestion.hints.length > 0) {
      <div class="hint-display">
        <h4>üí° Hint:</h4>
        <p>{{ currentQuestion.hints[hintsUsed - 1] }}</p>
      </div>
      }
    </div>
    <!-- question-content -->
    }
  </div>
  <!-- questions-step -->
  }
</div>
